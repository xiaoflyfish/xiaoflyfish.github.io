---
title: Volatile
categories: 
- 并发编程
---

volatile是Java虚拟机提供的轻量级的同步机制。

volatile关键字有如下两个作用

- 保证被volatile修饰的共享变量对所有线程总数可见的，也就是当一个线程修改了一个被volatile修饰共享变量的值，新值总是可以被其他线程立即得知。
- 禁止指令重排序优化。

**内存可见性**

- 第一： 使用volatile关键字会强制将修改的值立即写入主存；
- 第二： 使用volatile关键字的话，当线程2进行修改时， 会导致线程1的工作内存中缓存变量的缓存行无效；
- 第三： 由于线程1的工作内存中缓存变量的缓存行无效，所以线程1再次读取变量的值时会去主存读取。

**禁止重排序**

1.当程序执行到volatile变量的读操作或者写操作时， 在其前面的操作的更改肯定全部已经进行，且结果已经对后面的操作可见

2.在进行指令优化时，不能把volatile变量前面的语句放在其后面执行，也不能把volatile变量后面的语句放到其前面执行。

为了实现volatile的内存语义， 加入 volatile 关键字时， 编译器在生成字节码时，会在指令序列中插入内存屏障， 会多出一个 lock 前缀指令。

**内存屏障，有2个作用：**

1.先于这个内存屏障的指令必须先执行， 后于这个内存屏障的指令必须后执行。

2.使得内存可见性。 所以， 如果你的字段是 volatile， 在读指令前插入读屏障， 可以让高速缓存中的数据失效， 重新从主内存加载数据。 在写指令之后插入写屏障， 能让写入缓存的最新数据写回到主内存。