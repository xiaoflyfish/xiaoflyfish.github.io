---
title: 负载均衡
categories: 
- Nginx
---

负载均衡是指如何将网络请求派发到集群中的一个或多个节点上处理，一般来说，传统的负载均衡可以分为硬件负载均衡和软件负载均衡

硬件负载均衡，就是通过专门的硬件来实现负载均衡，比如常见的 `F5` 设备

软件负载均衡则是通过负载均衡软件实现，常见的就是 Nginx

**常见的复杂均衡策略**

> 轮询策略

每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除

```nginx
upstream backserver {
    server 192.168.0.14;
    server 192.168.0.15;
}
```

> 加权轮询

指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况

```nginx
upstream backserver {
    server 192.168.0.14 weight=3;
    server 192.168.0.15 weight=7;
}
```

> 随机策略

随机策略和轮询相似，从列表中随机的取一个，最好不要应用随机策略，可能会导致请求不均匀

> 最小响应时间

这个主要是在一些对请求延时敏感的场景中，在进行路由时，会优先发送给响应时间最小的节点

```nginx
upstream backserver {
    server server1;
    server server2;
    fair;
}
```

**url_hash（第三方）** 

按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效

```nginx
upstream backserver {
    server squid1:3128;
    server squid2:3128;
    hash $request_uri;
    hash_method crc32;
}
```

> 最小并发数策略

最小并发策略会记录当前时刻每个节点正在处理的事务数，在路由时选择并发最小的节点，最小并发策略可以比较好地反应服务器运行情况，适用于对系统负载较为敏感的场景

> ip_hash

如果客户已经访问了某个服务器，当用户再次访问时，会将该请求通过哈希算法，自动定位到该服务器

每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题

```nginx
upstream backserver {
    ip_hash;
    server 192.168.0.14:88;
    server 192.168.0.15:80;
}
```

**负载均衡如何实现**

在分布式服务调用中，根据负载均衡实现的位置不同，可以分为**服务端负载均衡和客户端负载均衡**

在服务器端负载均衡中，请求先发送到负载均衡服务器，然后通过负载均衡算法，在众多可用的服务器之中选择一个来处理请求

在客户端负载均衡中，不需要额外的负载均衡软件，客户端自己维护服务器地址列表，自己选择请求的地址，通过负载均衡算法将请求发送至该服务器
