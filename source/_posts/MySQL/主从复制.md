---
title: 主从复制
categories: 
- MySQL
---

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20201230215711.png" style="zoom:33%;" />

主库将变更写入 `binlog` 日志，从库连接到主库之后，主库会创建一个`log dump` 线程，用于发送 `bin log` 的内容。

从库开启同步以后，会创建一个 IO 线程用来连接主库，请求主库中更新的 `bin log`，I/O 线程接收到主库 `binlog dump` 进程发来的更新之后，保存在本地 `relay` 日志中。

接着从库中有一个 SQL 线程负责读取 `relay log` 中的内容，同步到数据库存储中，也就是在自己本地进行回放，最终保证主从数据的一致性。

**主从复制下的延时问题**

由于主库和从库是两个不同的数据源，主从复制过程会存在一个延时，当主库有数据写入之后，同时写入 `binlog` 日志文件中，然后从库通过 `binlog` 文件同步数据，由于需要额外执行日志同步和写入操作，这期间会有一定时间的延迟。特别是在高并发场景下，刚写入主库的数据是不能马上在从库读取的，要等待几十毫秒或者上百毫秒以后才可以。

在某些对一致性要求较高的业务场景中，这种主从导致的延迟会引起一些业务问题，比如订单支付，付款已经完成，主库数据更新了，从库还没有，这时候去从库读数据，会出现订单未支付的情况，在业务中是不能接受的。

**为了解决主从同步延迟的问题，通常有以下几个方法**

1.敏感业务强制读主库

在开发中有部分业务需要写库后实时读数据，这一类操作通常可以通过强制读主库来解决

2.关键业务不进行读写分离

对一致性不敏感的业务，比如电商中的订单评论、个人信息等可以进行读写分离，对一致性要求比较高的业务，比如金融支付，不进行读写分离，避免延迟导致的问题。

**主从复制如何避免丢数据**

假设在数据库主从同步时，主库宕机，并且数据还没有同步到从库，就会出现数据丢失和不一致的情况

**MySQL数据库主从复制有异步复制、半同步复制和全同步复制的方式**

> 异步复制

异步复制模式下，主库在接受并处理客户端的写入请求时，直接返回执行结果，不关心从库同步是否成功，这样主库崩溃以后，可能有部分操作没有同步到从库，出现数据丢失问题。

> 半同步复制

在半同步复制模式下，主库需要等待至少一个从库完成同步之后，才完成写操作。主库在执行完客户端提交的事务后，从库将日志写入自己本地的 `relay log` 之后，会返回一个响应结果给主库，主库确认从库已经同步完成，才会结束本次写操作。相对于异步复制，半同步复制提高了数据的安全性，避免了主库崩溃出现的数据丢失，但是同时也增加了主库写操作的耗时。

> 全同步复制

全同步复制指的是在多从库的情况下，当主库执行完一个事务，需要等待所有的从库都同步完成以后，才完成本次写操作。全同步复制需要等待所有从库执行完对应的事务，所以整体性能是最差的。

