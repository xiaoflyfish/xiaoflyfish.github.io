---
title: 生产环境搭建
categories: 
- 学习笔记
- ZooKeeper1
---

# 运行方式

首先，我们来介绍一下 ZooKeeper 服务的几种运行模式，ZooKeeper 的运行模式一般分为单机模式、伪集群模式、集群模式。其中单机模式和伪集群模式，在我们的日常开发中经常用到。

**单机模式配置**

在 ZooKeeper 的单机模式下，整个 ZooKeeper 服务只运行在一台服务器节点下。在` zoo.cfg `配置文件中，我们只定义了基本的 dataDir 目录和 clientPort 端口号等信息

```
tickTime=2000 
dataDir=/var/lib/zookeeper 
clientPort=2181
```

**伪集群模式配置**

与单机模式相比，伪集群模式的意思是：虽然 ZooKeeper 服务配置有多台服务器节点，但是这些集群服务器都运行在同一台机器上。 通常伪集群服务器在配置的时候，每台服务器间采用不同的端口号进行区分，多用在本地开发或测试中。

如下面的代码所示，在配置伪集群的时候，我们将每台服务器的 IP 地址都指向 127.0.0.1，即本机地址，每台 ZooKeeper 对外提供服务的端口分别是 2223、3334、4445

```
tickTime=2000 
dataDir=/var/lib/zookeeper 
clientPort=2181 
sever.1=127.0.0.1:2222:2223 
sever.2=127.0.0.1:3333:3334 
sever.3=127.0.0.1:4444:4445
```

**集群模式配置**

集群模式在配置上与伪集群模式基本相同。不同之处在于配置服务器地址列表的时候，组成 ZooKeeper 集群的各个服务器 IP 地址列表分别指向每台服务在网络中的实际 IP 地址

```
tickTime=2000 
dataDir=/var/lib/zookeeper 
clientPort=2181 
sever.1=192.168.1.101:2222:2223 
sever.1=192.168.1.102:3333:3334 
sever.1=192.168.1.103:4444:4445
```

在 ZooKeeper 集群的三种模式中，单机模式和伪集群模式经常用于开发和测试中。而分别利用不同网络上的物理机器组成的 ZooKeeper 集群经常被我们作为生成系统的环境配置方式

# 容器化部署

我们也使用 Docker 容器化技术来实现一个生产环境中的 ZooKeeper 集群部署案例

**使用 Docker 部署**

> 安装 Docker

为了使用 Docker 容器技术部署我们的应用服务，首先，我们要在服务器上安装 Docker 软件。以 Linux 系统中的 CentOS 7 64 位版本为例。如下面的代码所示，通过 curl 命令使用官方安装脚本自动安装。curl 通过资源地址获取资源到本地进行安装。而国内服务器由于网络等原因可能无法访问默认的 Docker 资源服务器，因此这里采用的是国内阿里云的镜像资源服务器

```
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
```

**创建 Docer 服务器**

安装完 Docker 后，接下来我们就开始部署 ZooKeeper 的集群环境。这里的集群环境仍然由三台 Linux 服务器组成。而与上面我们介绍的利用网络中三台实体机器不同，这三台服务器可以通过 Docker 的方式来创建。

如下面的代码所示，首先打开系统终端，输入 docker pull 获取需要的系统镜像文件，这里选择的是 3.6 版本的 ZooKeeper，当然我们也可以不指定具体版本号，系统会默认拉取最新版本的 ZooKeeper 。之后我们通过 docker run 命令来启动 ZooKeeper 镜像服务器。执行完这两个步骤，我们就拥有一台运行 ZooKeeper 服务的服务器了

```
docker pull zookeeper:3.6 
docker run -d --name=zookeeper1 --net=host zookeeper
```

**配置 ZooKeeper 服务**

创建完 ZooKeeper 服务器，接下来就要通过` zoo.cfg `文件来配置 ZooKeeper 服务。与部署在物理机器上不同，我们通过 docker exec 命令进入 Docker 创建的 ZooKeeper 服务器中，之后通过 vim 命令打开` zoo.cfg `文件进行相关配置

```
docker exec -it zookeeper1 /bin/bash 
vim /conf/zoo.cfg
```

**多台服务器配置**

按照上面介绍的方法，如果我们想搭建三台服务器规模的 ZooKeeper 集群服务，就需要重复上面的步骤三次，并分别在创建的三台 ZooKeeper 服务器进行配置。

不过在实际生产环境中，我们需要的 ZooKeeper 规模可能远远大于三台，而且这种逐一部署的方式不但浪费时间，在配置过程中出错率也较高。因此，这里介绍另一种配置方式，通过 Docker Compose 的方式来部署 ZooKeeper 集群。

Docker Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，你可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。如下面的代码所示，我们创建了一个名为` docker-compose.yml `的配置文件

```
version: '3.6'
services:
	zk1:
		image: zookeeper:3.6 
		restart: always
		hostname: zk1
		container_name: zk1 
		ports: - 2181:2181
		environment:
		 ZOO_MY_ID: 1
		 ZOO_SERVERS: server.1=zk1:2888:3888 server.2=zk2:2888:3888 server.3=zk3:2888:3888
	zk2:
		image: zookeeper:3.6 
		restart: always
		hostname: zk2
		container_name: zk2
		ports: - 2182:2181
		environment:
		 ZOO_MY_ID: 1
		 ZOO_SERVERS: server.1=zk1:2888:3888 server.2=zk2:2888:3888 server.3=zk3:2888:3888 
	zk3:
		image: zookeeper:3.6 
		restart: always
		hostname: zk3
		container_name: zk3
		ports: - 2183:2181
		environment:
		 ZOO_MY_ID: 1
		 ZOO_SERVERS: server.1=zk1:2888:3888 server.2=zk2:2888:3888 server.3=zk3:2888:3888
```

在这个文件中，我们将需要手工逐一创建的 ZooKeeper 服务器的创建过程，通过 docker-compose.yml 配置文件的方式进行了描述。在这个配置文件中，我们告诉 Docker 服务分别创建并运行三个 ZooKeeper 服务器，并分别将本地的 2181, 2182, 2183 端口绑定到对应容器的 2181 端口上。

Docker 容器化方式部署的服务默认情况下对外界隔离，默认的 Docker 容器内服务无法被外界访问，因此需要进行端口映射，将外部物理机器的端口映射到对应的 Docker 服务器端口，这样外界在对物理机器进行访问后，系统会自动映射该端口到对应的 Docker 服务上。

在 environment 节点下，我们配置了 ZooKeeper 集群需要的两个配置参数，分别是` ZOO_MY_ID` 以及 ZooKeeper 集群的服务器列表 `ZOO_SERVERS`。`ZOO_MY_ID`是 1-255 之间的整数，必须在集群中唯一。

**启动服务**

在编写完 `docker-compose.yml `配置文件的相关信息后，接下来我们就启动 docker 创建 ZooKeeper 集群服务。如下面的代码所示，首先，我们打开系统终端，输入 `docker-compose up `命令来启动服务器。之后终端会显示我们配置的三台服务器都成功启动

```
docker-compose up 
Name              Command               State           Ports 
---------------------------------------------------------------------- 
zk1   /docker-entrypoint.sh zkSe ...   Up      0.0.0.0:2181->2181/tcp 
zk2   /docker-entrypoint.sh zkSe ...   Up      0.0.0.0:2182->2181/tcp 
zk3   /docker-entrypoint.sh zkSe ...   Up      0.0.0.0:2183->2181/tcp
```

**访问服务**

ZooKeeper 集群配置完成并成功启动后，我们可以通过客户端命令来访问集群服务。如下面的代码所示，通过 `zkCli.sh -server `客户端命令来访问集群服务器

```
zkCli.sh -server localhost:2181,localhost:2182,localhost:2183
```

