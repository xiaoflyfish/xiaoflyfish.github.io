---
title: 实现负载均衡
categories: 
- 学习笔记
- ZooKeeper1
---

**状态收集**

首先我们来实现网络中服务器运行状态的收集功能，利用 ZooKeeper 中的临时节点作为标记网络中服务器的状态点位。在网络中服务器上线运行的时候，通过在 ZooKeeper 服务器中创建临时节点，向 ZooKeeper 的服务列表进行注册，表示本台服务器已经上线可以正常工作。通过删除临时节点或者在与 ZooKeeper 服务器断开连接后，删除该临时节点。

最后，通过统计临时节点的数量，来了解网络中服务器的运行情况。**如下所示，建立的 ZooKeeper 数据模型中 Severs 节点可以作为存储服务器列表的父节点**。用于之后通过负载均衡算法在该列表中选择服务器。在它下面创建 servers_host1、servers_host2、servers_host3等临时节点来存储集群中的服务器运行状态信息

在代码层面的实现中，我们首先定义一个 BlanceSever 接口类。该类规定在 ZooKeeper 服务器启动后，向服务器地址列表中，注册或注销信息以及根据接收到的会话请求，动态更新负载均衡情况等功能

```java
public class BlanceSever{
  public void register()
  public void unregister()
  public void addBlanceCount()
  public void takeBlanceCount()
  
}
```

之后我们创建 BlanceSever 接口的实现类 BlanceSeverImpl，在 BlanceSeverImpl 类中首先定义服务器运行的 Session 超时时间、会话连接超时时间、ZooKeeper 客户端地址、服务器地址列表节点 ‘/Severs’ 等基本参数。并通过构造函数，在类被引用时进行初始化 ZooKeeper 客户端对象实例

```java
public class BlanceSeverImpl implements BlanceSever{
  private static final Integer SESSION_TIME_OUT
  private static final Integer CONNECTION_TIME_OUT
  private final ZkClient zkclient
  private static final SERVER_PATH="/Severs"
  public BlanceSeverImpl(){
    init...
  }
  
}
```

接下来，在定义当服务器启动时，向服务器地址列表注册信息的 register 函数。在函数的内部，通过在 `SERVER_PATH `路径下创建临时子节点的方式来注册服务器信息。如下面的代码所示，首先获取服务器的 ip 地址，利用 ip 地址作为临时节点的 path 来创建临时节点

```java
public register() throws Exception{
  InetAddress address = InetAddress.getLocalHost();
  String serverIp=address.getHostAddress()
  zkclient.createEphemeral(SERVER_PATH+serverIp)
}
```

register 函数在服务器启动并注册服务器信息后，我们再来定义 unregister 方法，该方法是当服务器关机或由于其他原因不再对外提供服务时，通过调用 unregister 方法，注销该台服务器在服务器列表中的信息。

注销后的机器不会被负载均衡服务器分发处理会话。如下面的代码所示，在 unregister 函数的内部，我们主要通过删除 `SERVER_PATH` 路径下临时节点的方式注销服务器

```java
public unregister() throws Exception{
  zkclient.delete(SERVER_PATH+serverIp)
}
```

# 负载算法

实现服务器列表后，接下来我们就进入负载均衡最核心的内容：如何选择服务器。这里我们通过采用**“最小连接数”**算法，来确定究竟如何均衡地分配网络会话请求给后台客户端。

整个实现的过程如下图所示。首先，在接收到客户端的请求后，通过 getData 方法获取服务端 Severs 节点下的服务器列表，其中每个节点信息都存储有当前服务器的连接数。通过判断选择最少的连接数作为当前会话的处理服务器，并通过 setData 方法将该节点连接数加 1。最后，当客户端执行完毕，再调用 setData 方法将该节点信息减 1

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210216195353.png" style="zoom:33%;" />

首先，我们定义当服务器接收到会话请求后。在 ZooKeeper 服务端增加连接数的 addBlance 方法。如下面的代码所示，首先我们通过 readData 方法获取服务器最新的连接数，之后将该连接数加 1，再通过 writeData 方法将新的连接数信息写入到服务端对应节点信息中

```java
public void addBlance() throws Exception{
  InetAddress address = InetAddress.getLocalHost();
  String serverIp=address.getHostAddress()
  Integer con_count=zkClient.readData(SERVER_PATH+serverIp)
  ++con_count
  zkClient.writeData(SERVER_PATH+serverIp,con_count)
}
```

当服务器处理完该会话请求后，需要更新服务端相关节点的连接数。具体的操作与 addBlance 方法基本一样，只是对获取的连接信息进行减一操作