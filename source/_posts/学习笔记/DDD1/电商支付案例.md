---
title: 电商支付案例
categories: 
- 学习笔记
- DDD1
---

关于用户付款功能的需求描述是这样的：

- 在用户下单以后，经过下单流程进入付款功能；

- 通过用户档案获得用户名称、地址等信息；

- 记录商品及其数量，并汇总付款金额；

- 保存订单；

- 通过远程调用支付接口进行支付

采用领域驱动的方式，在拿到新需求以后，应当先进行需求分析，设计领域模型

按照以上业务场景，可以分析出：

- 该场景中有“订单”，每个订单都对应一个用户；

- 一个用户可以有多个用户地址，但每个订单只能有一个用户地址；

- 此外，一个订单对应多个订单明细，每个订单明细对应一个商品，每个商品对应一个供应商

我们对订单可以进行“下单”“付款”“查看订单状态”等操作。因此形成了以下领域模型图：

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210213235606.png" style="zoom:33%;" />

通过领域模型的指导，将“订单”分为订单 Service 与值对象，将“用户”分为用户 Service 与值对象，将“商品”分为商品 Service 与值对象……然后，在此基础上实现各自的方法

**商品折扣的需求变更**

当电商网站的付款功能按照领域模型完成了第一个版本的设计后，很快就迎来了第一次需求变更，即增加折扣功能，并且该折扣功能分为限时折扣、限量折扣、某类商品的折扣、某个商品的折扣与不折扣

按照领域驱动设计的思想，应当将需求变更还原到领域模型中进行分析，进而根据领域模型背后的真实世界进行变更

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210213235805.png" style="zoom:33%;" />

怎样去分析“付款”与“折扣”之间的关系呢

- 当“付款”发生变更时，“折扣”是不是一定要变？

- 当“折扣”发生变更时，“付款”是不是一定要变？


当这两个问题的答案是否定时，就说明“付款”与“折扣”是软件变化的两个不同的原因，那么把它们放在一起，放在同一个类、同一个方法中，合适吗？不合适，就应当将“折扣”从“付款”中提取出来，单独放在一个类中。

同样的道理：

- 当“限时折扣”发生变更的时候，“限量折扣”是不是一定要变？

- 当“限量折扣”发生变更的时候，“某类商品的折扣”是不是一定要变？


最后发现，不同类型的折扣也是软件变化不同的原因。将它们放在同一个类、同一个方法中，合适吗？

通过以上分析，我们做出了如下设计：

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210214000046.png" style="zoom:33%;" />

**VIP 会员的需求变更**

在第一次变更的基础上，很快迎来了第二次变更，这次是要增加 VIP 会员，业务需求如下。

- 增加 VIP 会员功能：

- 对不同类型的 VIP 会员（金卡会员、银卡会员）进行不同的折扣；

- 在支付时，为 VIP 会员发放福利（积分、返券等）；

- VIP 会员可以享受某些特权。


我们拿到这样的需求又应当怎样设计呢

同样，先回到领域模型，分析“用户”与“VIP 会员”的关系，“付款”与“VIP 会员”的关系

- “用户”发生变更时，“VIP 会员”是否要变？

- “VIP 会员”发生变更时，“用户”是否要变？


通过分析发现，“用户”与“VIP 会员”是两个完全不同的事物。

而“付款”与“VIP 会员”的关系是在付款的过程中去调用会员折扣、会员福利与会员特权。

通过以上的分析，我们做出了以下版本的领域模型：

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210214182922.png" style="zoom:33%;" />