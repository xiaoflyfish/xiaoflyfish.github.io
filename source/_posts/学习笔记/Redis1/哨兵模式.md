---
title: 哨兵模式
categories: 
- 学习笔记
- Redis1
---

哨兵其实就是一个运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行

哨兵主要负责的就是三个任务：监控、选主（选择主库）和通知。

**监控**

监控是指哨兵进程在运行时，周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。

如果从库没有在规定时间内响应哨兵的 PING 命令，哨兵就会把它标记为“下线状态”；同样，如果主库也没有在规定时间内响应哨兵的 PING 命令，哨兵就会判定主库下线，然后开始**自动切换主库的流程**。

**选主**

主库挂了以后，哨兵就需要从很多个从库里，按照一定的规则选择一个从库实例，把它作为新的主库。这一步完成后，现在的集群里就有了新主库。

**通知**

在执行通知任务时，哨兵会把新主库的连接信息发给其他从库，让它们执行 replicaof 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上

**如何判断主库的下线状态**

哨兵对主库的下线判断有“主观下线”和“客观下线”两种

> 主观下线

如果哨兵发现主库或从库对 PING 命令的响应超时了，那么，哨兵就会先把它标记为“主观下线”

- 如果检测的是从库，那么，哨兵简单地把它标记为“主观下线”就行了，因为从库的下线影响一般不太大，集群的对外服务不会间断。
- 如果检测的是主库, 那么不会直接标注为 "主观下线", 还要进行是否**误判**的检测

通常会采用多实例组成的集群模式进行部署，这也被称为**哨兵集群**。引入多个哨兵实例一起来判断，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。

在判断主库是否下线时，不能由一个哨兵说了算，**只有大多数的哨兵实例，都判断主库已经“主观下线”了，主库才会被标记为“客观下线”.**

> 客观下线

“客观下线”的标准就是:

- 最好要有` N/2 + 1` 个实例判断主库为“主观下线”，才能最终判定主库为“客观下线”
- 有多少个实例做出“主观下线”的判断才可以，可以由 Redis 管理员自行设定

**如何选定新主库**

一般来说，我把哨兵选择新主库的过程称为“**筛选 + 打分**”。

简单来说，我们在多个从库中，先按照一定的筛选条件，把不符合条件的从库去掉。然后，我们再按照一定的规则，给剩下的从库逐个打分，将得分最高的从库选为新主库

> 筛选条件

- 仍然在线的从库
- 从库之前的网络状态

使用配置项 `down-after-milliseconds * 10`。其中，down-after-milliseconds 是我们认定主从库断连的最大连接超时时间。如果在 down-after-milliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好，不适合作为新主库。

> 打分

我们可以分别按照三个规则依次进行三轮打分，这三个规则分别是从库优先级、从库复制进度以及从库 ID 号。只要在某一轮中，有从库得分最高，那么它就是主库了，选主过程到此结束。如果没有出现得分最高的从库，那么就继续进行下一轮

- 第一轮：优先级最高的从库得分高

用户可以通过 **slave-priority** 配置项，给不同的从库设置不同优先级。比如，你有两个从库，它们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么它就是新主库了。如果从库的优先级都一样，那么哨兵开始第二轮打分。

- 第二轮：和旧主库同步程度最接近的从库得分高。

**如何判断从库和旧主库间的同步进度**

主从库同步时有个命令传播的过程。在这个过程中，主库会用 **master_repl_offset** 记录当前的最新写操作在 `repl_backlog_buffer` 中的位置，而从库会用 **slave_repl_offset** 这个值记录当前的复制进度。

此时，我们想要找的从库，它的 `slave_repl_offset` 需要最接近 `master_repl_offset`。如果在所有从库中，有从库的 `slave_repl_offset` 最接近 `master_repl_offset`，那么它的得分就最高，可以作为新主库。

当然，如果有两个从库的`slave_repl_offset` 值大小是一样的，我们就需要给它们进行第三轮打分了。

- 第三轮：ID 号小的从库得分高。

每个实例都会有一个 ID，这个 ID 就类似于这里的从库的编号。目前，Redis 在选主库时，有一个默认的规定：**在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库**

# 哨兵集群

实际上，**一旦多个实例组成了哨兵集群，即使有哨兵实例出现故障挂掉了，其他哨兵还能继续**协作完成主从库切换的工作，包括判定主库是不是处于下线状态，选择新主库，以及通知从库和客户端。

**哨兵实例之间可以相互发现，要归功于 Redis 提供的 pub/sub 机制，也就是发布 / 订阅机制。**

- 哨兵将自己的连接信息 (ip, port) 发布到主库上, 其它哨兵订阅
- 自己编写的应用程序也可以通过 Redis 进行消息的发布和订阅
- Redis 会以**频道**的形式，对这些消息进行分门别类的管理

所谓的频道，实际上就是消息的类别。当消息类别相同时，它们就属于同一个频道。反之，就属于不同的频道。只有订阅了同一个频道的应用，才能通过发布的消息进行信息交换。

在主从集群中，主库上有一个名为“**__sentinel__:hello**”的频道，不同哨兵就是通过它来相互发现，实现互相通信的

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210220213700.png" style="zoom:33%;" />

哨兵除了彼此之间建立起连接形成集群外，还需要和从库建立连接。这是因为，在哨兵的监控任务中，它需要对主从库都进行心跳判断，而且在主从库切换完成后，它还需要通知从库，让它们和新主库进行同步。

**哨兵如何发现从库 ip, port**

这是由哨兵向主库发送 INFO 命令来完成的

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210220213806.png" style="zoom:33%;" />

哨兵也和客户端连接:

- 主从库切换后，客户端也需要知道新主库的连接信息，才能向新主库发送请求操作。所以，哨兵还需要完成把新主库的信息告诉客户端这个任务。
- 实际使用哨兵时要求，客户端能够获取到哨兵集群在监控、选主、切换这个过程中发生的各种事件。

从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。

所以，**每个哨兵实例也提供 pub/sub 机制**，客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210220213941.png" style="zoom:33%;" />

让客户端从哨兵这里订阅消息:

1. 客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接
2. 在客户端执行订阅命令，来获取不同的事件消息

```
// 订阅“所有实例进入客观下线状态的事件”：
SUBSCRIBE +odown

// 订阅所有的事件
PSUBSCRIBE  *
```

当哨兵把新主库选择出来后，客户端就会看到下面的 switch-master 事件。这个事件表示主库已经切换了，新主库的 IP 地址和端口信息已经有了。这个时候，客户端就可以用这里面的新主库地址和端口进行通信了

```
switch-master <master name> <oldip> <oldport> <newip> <newport>
```

**由哪个哨兵执行主从切换**

判断主库下线的过程:

1. 任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送 `is-master-down-by-addr` 命令。接着，其他实例会根据自己和主库的连接情况，做出 Y 或 N 的响应，Y 相当于赞成票，N 相当于反对票

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210220214145.png" style="zoom:33%;" />

一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为“客观下线”。这个所需的赞成票数是通过哨兵配置文件中的 **quorum** 配置项设定的。例如，现在有 5 个哨兵，quorum 配置的是 3，那么，一个哨兵需要 3 张赞成票，就可以标记主库为“客观下线”了。这 3 张赞成票包括哨兵自己的一张赞成票和另外两个哨兵的赞成票。

1. 此时，这个哨兵就可以再给其他哨兵发送命令，表明希望由自己来执行主从切换，并让所有其他哨兵进行投票。这个投票过程称为“**Leader 选举**”。因为最终执行主从切换的哨兵称为 Leader，投票过程就是确定 Leader。

任何一个想成为 Leader 的哨兵，要满足两个条件:

- 拿到半数以上的赞成票
- 拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值

以 3 个哨兵为例，假设此时的 quorum 设置为 2，那么，任何一个想成为 Leader 的哨兵只要拿到 2 张赞成票，就可以了

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210220214317.png" style="zoom:33%;" />

如果 S3 没有拿到 2 票 Y，那么这轮投票就不会产生 Leader。哨兵集群会等待一段时间（也就是哨兵故障转移超时时间的 2 倍），再重新选举。这是因为，哨兵集群能够进行成功投票，很大程度上依赖于选举命令的正常网络传播。如果网络压力较大或有短时堵塞，就可能导致没有一个哨兵能拿到半数以上的赞成票。所以，等到网络拥塞好转之后，再进行投票选举，成功的概率就会增加。

**需要注意的是，如果哨兵集群只有 2 个实例，此时，一个哨兵要想成为 Leader，必须获得 2 票，而不是 1 票。所以，如果有个哨兵挂掉了，那么，此时的集群是无法进行主从库切换的。因此，通常我们至少会配置 3 个哨兵实例。这一点很重要，你在实际应用时可不能忽略了**