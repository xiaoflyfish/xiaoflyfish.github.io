---
title: 内存碎片
categories: 
- 学习笔记
- Redis1
---

**内存碎片是如何形成的**

> 内因：内存分配器的分配策略

内存分配器的分配策略就决定了操作系统无法做到“按需分配”。这是因为，内存分配器一般是按固定大小来分配内存，而不是完全按照应用程序申请的内存空间大小给程序分配。

Redis 可以使用 libc、**jemalloc**、tcmalloc 多种内存分配器来分配内存，默认使用 jemalloc。

jemalloc 的分配策略之一，是按照一系列固定的大小划分内存空间，例如 8 字节、16 字节、32 字节、48 字节，…, 2KB、4KB、8KB 等。当程序申请的内存最接近某个固定值时，jemalloc 会给它分配相应大小的空间。

如果 **Redis 每次向分配器申请的内存空间大小不一样**，这种分配方式就会有形成碎片的风险，而这正好来源于 Redis 的外因了。

> 外因：键值对大小不一样和删改操作

比如说，应用 A 保存 6 字节数据，jemalloc 按分配策略分配 8 字节

如果应用 A 不再保存新数据，那么，这里多出来的 2 字节空间就是内存碎片了

第二个外因是，这些键值对会被修改和删除，这会导致空间的扩容和释放。具体来说，一方面，如果修改后的键值对变大或变小了，就需要占用额外的空间或者释放不用的空间。另一方面，删除的键值对就不再需要内存空间了，此时，就会把空间释放出来，形成空闲空间

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210226140436.png" style="zoom:33%;" />

**如何判断是否有内存碎片**

info 命令:

```
INFO memory
# Memory
used_memory:1073741736
used_memory_human:1024.00M
used_memory_rss:1997159792
used_memory_rss_human:1.86G
…
mem_fragmentation_ratio:1.86
```

mem_fragmentation_ratio: Redis 当前的内存碎片率

used_memory_rss: 操作系统实际分配给 Redis 的物理内存空间，里面就包含了碎片

used_memory: Redis 为了保存数据实际申请使用的空间

```
mem_fragmentation_ratio = used_memory_rss/ used_memory
```

经验阈值：

- mem_fragmentation_ratio 大于 1 但小于 1.5。这种情况是合理的。这是因为，刚才我介绍的那些因素是难以避免的。毕竟，内因的内存分配器是一定要使用的，分配策略都是通用的，不会轻易修改；而外因由 Redis 负载决定，也无法限制。所以，存在内存碎片也是正常的。
- mem_fragmentation_ratio 大于 1.5 。这表明内存碎片率已经超过了 50%。一般情况下，这个时候，我们就需要采取一些措施来降低内存碎片率了

**如何清理内存碎片**

从 4.0-RC3 版本以后，Redis 自身提供了一种内存碎片自动清理的方法

基本机制:

- 内存碎片清理，简单来说，就是“搬家让位，合并空间”。

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/image.png" style="zoom:13%;" />

Redis 专门为自动内存碎片清理功机制设置的参数:

- 控制碎片清理的开始和结束时机
- 占用的 CPU 比例
- 从而减少碎片清理对 Redis 本身请求处理的性能影响

首先，Redis 需要**启用自动内存碎片清理**，可以把 activedefrag 配置项设置为 yes，命令如下：

```
config set activedefrag yes
```

触发清理的条件 (需要同时满足):

- active-defrag-ignore-bytes 100mb：表示内存碎片的字节数达到 100MB 时，开始清理；
- active-defrag-threshold-lower 10：表示内存碎片空间占操作系统分配给 Redis 的总空间比例达到 10% 时，开始清理。

为了尽可能减少碎片清理对 Redis 正常请求处理的影响，自动内存碎片清理功能在执行时，还会监控清理操作占用的 CPU 时间，而且还设置了两个参数，分别用于控制清理操作占用的 CPU 时间比例的上、下限，既保证清理工作能正常进行，又避免了降低 Redis 性能

这两个参数具体如下：

- active-defrag-cycle-min 25： 表示自动清理过程所用 CPU 时间的比例不低于 25%，保证清理能正常开展；
- active-defrag-cycle-max 75：表示自动清理过程所用 CPU 时间的比例不高于 75%，一旦超过，就停止清理，从而避免在清理时，大量的内存拷贝阻塞 Redis，导致响应延迟升高。