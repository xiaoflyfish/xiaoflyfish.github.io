---
title: 哨兵模式
categories: 
- Redis
---

Redis Sentinel 是 Redis 高可用 的实现方案

Sentinel 是一个管理多个 Redis 实例的工具，它可以实现对 Redis 的 监控、通知、自动故障转移

Redis 的 Sentinel 最小配置是 一主一从

**主观下线和客观下线**

默认情况下，每个 Sentinel 节点会以 每秒一次 的频率对 Redis 节点和 其它 的 `Sentinel` 节点发送 PING 命令，并通过节点的 回复 来判断节点是否在线

> 主观下线

主观下线 适用于所有 主节点 和 从节点。如果在 `down-after-milliseconds` 毫秒内，Sentinel 没有收到 目标节点 的有效回复，则会判定 该节点 为 主观下线

> 客观下线

客观下线 只适用于 主节点。如果 主节点 出现故障，Sentinel 节点会通过 `sentinel is-master-down-by-addr` 命令，向其它 Sentinel 节点询问对该节点的 状态判断。如果超过 ` <quorum>`个数的节点判定 主节点 不可达，则该 Sentinel 节点会判断 主节点 为 客观下线

# 工作原理

每个 `Sentinel` 节点都需要 定期执行 以下任务：

- 每个 Sentinel 以 每秒钟 一次的频率，向它所知的 主服务器、从服务器 以及其他 `Sentinel` 实例 发送一个 PING 命令。
- 如果一个 实例距离 最后一次 有效回复 PING 命令的时间超过 `down-after-milliseconds` 所指定的值，那么这个实例会被 Sentinel 标记为**主观下线**。
- 如果一个 主服务器 被标记为 主观下线，那么正在 监视 这个 主服务器 的所有 `Sentinel` 节点，要以 每秒一次 的频率确认 主服务器 的确进入了 主观下线 状态。
- 如果一个 主服务器 被标记为 主观下线，并且有 足够数量 的 `Sentinel`（至少要达到 配置文件 指定的数量）在指定的 时间范围 内同意这一判断，那么这个 主服务器 被标记为**客观下线**。
- 在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率，向它已知的所有 主服务器 和 从服务器 发送 INFO 命令。当一个 主服务器 被 Sentinel 标记为 客观下线 时，`Sentinel` 向 下线主服务器 的所有 从服务器 **发送INFO** 命令的频率，会从 10 秒一次改为 每秒一次。
- Sentinel 和其他 Sentinel 协商 主节点 的状态，如果 主节点 处于 `SDOWN` 状态，则**投票自动选出新的主节点**。将剩余的 从节点 指向 新的主节点 进行 数据复制。
- 当没有足够数量的 `Sentinel` 同意 主服务器 下线时， 主服务器 的 客观下线状态 就会被移除。当 主服务器 重新向 Sentinel 的 `PING` 命令返回 有效回复 时，主服务器 的 主观下线状态 就会被移除。

# 选主

一般来说，我把哨兵选择新主库的过程称为**筛选 + 打分**。简单来说，我们在多个从库中，先按照一定的筛选条件，把不符合条件的从库去掉。然后，我们再按照一定的规则，给剩下的从库逐个打分，将得分最高的从库选为新主库

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20201223191945.png" alt="img" style="zoom:40%;" />

如果在 `down-after-milliseconds` 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好，不适合作为新主库

我们可以分别按照三个规则依次进行三轮打分，这三个规则分别是**从库优先级、从库复制进度以及从库ID号**

只要在某一轮中，有从库得分最高，那么它就是主库了，选主过程到此结束。如果没有出现得分最高的从库，那么就继续进行下一轮