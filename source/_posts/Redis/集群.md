---
title: 内存回收
categories: 
- Redis
---

Redis Cluster 是 在 3.0 版本正式推出的高可用集群方案，相比`Redis Sentinel`，Redis Cluster方案不需要额外部署Sentinel集群，而是通过集群内部通信实现集群监控，故障时主从切换；同时，支持内部基于哈希实现数据分片，支持动态水平扩容

# 数据分片

Redis Cluster首先定义了编号`0 ~ 16383`的区间，称为槽，所有的键根据哈希函数映射到`0 ~ 16383`整数槽内，计算公式：`slot=CRC16（key）&16383`。每一个节点负责维护一部分槽以及槽所映射的键值数据

每个集群节点维护着一个`16384 bit (2kB)`的位数组，每个bit对应相同编号的槽，用 0 / 1标识对于某个槽自己是否拥有

# 集群扩容

Redis Cluster支持不影响集群对外服务的情况下，对集群进行动态扩容或缩容，当Redis 新节点加入现有集群后，需要为其迁移槽和数据，确保迁移后每个节点负责相似数量的槽，使数据分布均匀在各节点上 整个数据迁移涉及系列操作

Redis提供了集群管理工具，包括基于Ruby的`redis-trib.rb`，还Redis5新提供的基于C语言`redis-cli`

**下面的介绍以`redis-cli`为例 源节点将指定slot数据迁移到目标节点，基本流程如下：**

- redis-cli设置目标节点指定slot状态importing，让目标节点准备迁入slot数据
- redis-cli设置源节点指定slot状态migrating，让让源节点准备迁出slot的数据
- redis-cli批量迁移源节点指定slot中的数据到目标节点
- 数据迁移完后 `redis-cli`向集群所有主节点通知槽被分配给目标节点，主节点更新slot与节点映射关系信息

通常情况下，如果客户端请求的数据不在节点上，节点会回复 `MOVED` 重定向信息，客户端根据该信息再请求正确的节点

**ASK和MOVED这2个重定向区别：**

- ASK 重定向说明集群正在进行 slot 数据迁移，客户端无法知道什么时候迁移完成，因此只能是临时性的重定向，客户端不会更新 slot 到 Redis 节点的映射缓存。
- MOVED 重定向说明键对应的slot 已经明确指定到新的节点，因此需要更新 slot 到 Redis 节点的映射缓存

# 节点通信机制

redis cluster 节点间采用 gossip 协议进行通信。

在 redis cluster 架构下，每个 redis 要放开两个端口号，比如一个是 6379，另外一个就是 加 1w 的端口号，比如 16379。

16379 端口号是用来进行节点间通信的

gossip 协议，所有节点都持有一份元数据，不同的节点如果出现了元数据的变更，就不断将元数据发送给其它的节点，让其它节点也进行元数据的变更。