---
title: 内存回收
categories: 
- Redis
---

# 过期删除策略

## 定时删除

对于每一个设置了过期时间的key都会创建一个定时器，一旦到达过期时间就立即删除。

该策略可以立即清除过期的数据，对内存较友好，但是缺点是占用了大量的CPU资源去处理过期的数据，会影响Redis的吞吐量和响应时间。

## 惰性删除

当访问一个key时，才判断该key是否过期，过期则删除。

该策略能最大限度地节省CPU资源，但是对内存却十分不友好。有一种极端的情况是可能出现大量的过期key没有被再次访问，因此不会被清除，导致占用了大量的内存。

## 定期删除

每隔一段时间，扫描Redis中过期key字典，并清除部分过期的key。该策略是前两者的一个折中方案，还可以通过调整定时扫描的时间间隔和每次扫描的限定耗时，在不同情况下使得CPU和内存资源达到最优的平衡效果。

在Redis中，同时使用了定期删除和惰性删除。

## Lazy Free

lazy free 特性是 Redis 4.0 新增的一个非常使用的功能，它可以理解为惰性删除或延迟删除。

意思是在删除的时候提供异步延时释放键值的功能，把键值释放操作放在 BIO单独的子线程处理中，以减少删除删除对 Redis 主线程的阻塞，可以有效地避免删除 big key 时带来的性能和可用性问题。

lazy free 对应了 4 种场景，默认都是关闭的：

```
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
slave-lazy-flush no
```

`lazyfree-lazy-eviction`：表示当 Redis 运行内存超过 maxmeory 时，是否开启 lazy free 机制删除；

`lazyfree-lazy-expire`：表示设置了过期时间的键值，当过期之后是否开启 lazy free 机制删除；

`lazyfree-lazy-server-del`：有些指令在处理已存在的键时，会带有一个隐式的 del 键的操作，比如 rename 命令，当目标键已存在，Redis 会先删除目标键，如果这些目标键是一个 big key，就会造成阻塞删除的问题，此配置表示在这种场景中是否开启 lazy free 机制删除；

`slave-lazy-flush`：针对 slave(从节点) 进行全量数据同步，slave 在加载 master 的 RDB 文件前，会运行 flushall 来清理自己的数据，它表示此时是否开启 lazy free 机制删除。

建议开启其中的 `lazyfree-lazy-eviction、lazyfree-lazy-expire、lazyfree-lazy-server-del `等配置，这样就可以有效的提高主线程的执行效率。