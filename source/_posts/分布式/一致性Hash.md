---
title: 一致性Hash
categories: 
- 分布式
---

一般用取模算法把数据尽量平均地放到这4台Redis中：`hash( key ) % N`，N 为 Redis 的数量

在这里 N = 4，如果4 台 `Redis` 不够了，需要再增加 4 台 Redis，那么这个求余算法就会变成：`hash( key ) % 8，`这样大部分缓存的位置都会是错误的，极端情况下，就会造成缓存雪崩

**一致性Hash算法可以很好地解决这个问题，它的大概过程是这样的：**

把 0 作为起点，`2^32-1` 作为终点，画一条直线，再把起点和终点重合，直线变成一个圆，方向是顺时针从小到大，0 的右侧第一个点是 1 ，然后是 2 ，以此类推

对三台服务器的 IP 或其他关键字进行 hash 后对 `2^32` 取模，这样势必能落在这个圈上的某个位置，记为 Node1、Node2、Node3

然后对数据 key 进行相同的操作，势必也会落在圈上的某个位置；然后顺时针行走，可以找到某一个 `Node`，这就是这个 key 要储存的服务器

如果增加一台服务器或者删除一台服务器，只会影响部分数据

但如果节点太少或分布不均匀的时候，容易造成**数据倾斜**，也就是大部分数据会集中在某一台服务器上

为了解决数据倾斜问题，一致性 `Hash` 算法提出了虚拟节点，会对每一个服务节点计算多个哈希，然后放到圈上的不同位置