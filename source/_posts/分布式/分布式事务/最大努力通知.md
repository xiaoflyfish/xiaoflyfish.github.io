---
title: 最大努力通知
categories: 
- 分布式
- 分布式事务
---

最大努力通知型是最简单的一种柔性事务，适用于一些最终一致性时间敏感度低的业务，且被动方处理结果不影响主动方的处理结果

**典型的使用场景：如银行通知、商户通知等。最大努力通知型的实现方案，一般符合以下特点：**

  1、不可靠消息：业务活动主动方，在完成业务处理之后，向业务活动的被动方发送消息，直到通知N次后不再通知，允许消息丢失(不可靠消息)

  2、定期校对：业务活动的被动方，根据定时策略，向业务活动主动方查询(主动方提供查询接口)，恢复丢失的业务消息

举例来说：一个短信发送平台，背景是公司内部有多个业务都有发送短信的需求，如果每个业务独立实现短信发送功能，存在功能实现上的重复

因此专门做了一个短信平台项目，所有的业务方都接入这个短信平台，来实现发送短信的功能

简化后的架构如下所示：

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210214170921.png" style="zoom:33%;" />

**短信发送流程如下：**

1、业务方将短信发送请求提交给短信平台

2、短信平台接收到要发送的短信，记录到数据库中，并标记其状态为”已接收"

3、短信平台调用外部短信发送供应商的接口，发送短信。外部供应商的接口也是异步将短信发送到用户手机上，因此这个接口调用后，立即返回，进入第4步。

4、更新短信发送状态为"已发送"

5、短信发送供应商异步通知短信平台短信发送结果。而通知可能失败，因此最多只会通知N次。

6、短信平台接收到短信发送结果后，更新短信发送状态，可能是成功，也可能失败(如手机欠费)。到底是成功还是失败并不重要，重要的是我们知道了这调短信发送的最终结果

7、如果最多只通知N次，如果都失败了的话，那么短信平台将不知道短信到底有没有成功发送。因此短信发送供应商需要提供一个查询接口，以方便短信平台驱动的去查询，进行定期校对。

在这个案例中，短信发送供应商通知短信平台短信发送结果的过程中，就是最典型的最大努力通知型方案，通知了N次就不再通知。通过提供一个短信结果查询接口，让短信平台可以进行定期的校对。而由于短信发送业务的时间敏感度并不高，比较适合采用这个方案。

需要注意的是，短信结果查询接口很重要，必须要进行定期校对。因为后期要进行对账