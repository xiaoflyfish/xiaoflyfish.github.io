---
title: 消息顺序
categories: 
- KAFKA
---

**乱序场景一**

因为一个topic可以有多个partition，kafka只能保证单个partition内部有序

**解决方案**

1、可以设置topic 有且只有一个partition

2、根据业务需要，需要顺序的指定为同一个partition

**乱序场景二**

对于同一业务进入了同一个消费者组之后，用了多线程来处理消息，会导致消息的乱序

**解决方案**

消费者内部根据线程数量创建等量的内存队列，对于需要顺序的一系列业务数据，根据key或者业务数据，放到同一个内存队列中，然后线程从对应的内存队列中取出并操作

**通过设置相同key来保证消息有序性，会有一点缺陷:**

例如消息发送设置了重试机制，并且异步发送，消息A和B设置相同的key，业务上A先发，B后发，由于网络或者其他原因A发送失败，B发送成功；A由于发送失败就会重试且重试成功，这时候消息顺序B在前A在后，与业务发送顺序不一致，如果需要解决这个问题，需要设置参数`max.in.flight.requests.per.connection=1`，其含义是限制客户端在单个连接上能够发送的未响应请求的个数，设置此值是1表示kafka broker在响应请求之前client不能再向同一个broker发送请求，这个参数默认值是5

官方文档说明如下，这个参数如果大于1，由于重试消息顺序可能重排

