---
title: 选举机制
categories: 
- 消息队列
- KAFKA
---

Kafka集群中的选举大致可以分为：控制器的选举、分区leader的选举

# 控制器选举

在Kafka集群中有多个broker，那么就有一个broker会被选举为控制器（Kafka Controller），它的作用负责管理整个集群中所有分区和副本的状态。

比如当某个分区的leader副本出现故障时，由控制器负责为该分区选举新的leader副本。再比如当检测到某个分区的ISR集合发生变化时，由控制器负责通知所有broker更新其元数据信息。

控制器的选举是由Zookeeper的节点的唯一性来做到的，在kafka中多个broker启动后会在Zookeeper创建`/controller`这个临时（EPHEMERAL）节点，哪个broker创建成功，那么它就成为了控制器，其它竞争失败的broker会进行watch注册

# 分区Leader选举

对于kafka集群中对于任意的topic的分区以及副本leader的设定，都需要考虑到集群整体的负载能力的平衡性，会尽量分配每一个partition的副本leader在不同的broker中，这样会避免多个leader在同一个broker，导致集群中的broker负载不平衡

kafka引入了优先副本的概念，优先副本的意思在AR集合列表中的第一个副本，在理想状态下该副本就是该分区的leader副本

例如kafka集群由3台broker组成，创建了一个名为`topic-partitions`的topic，设置partition为3，副本数为3，partition0中AR列表为 [1,2,0],那么分区0的优先副本为1