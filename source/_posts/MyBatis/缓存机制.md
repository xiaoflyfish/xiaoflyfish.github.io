---
title: 缓存机制
categories: 
- MyBatis
---

# 一级缓存

在应用运行过程中，我们有可能在一次数据库会话中，执行多次查询条件完全相同的SQL，MyBatis提供了一级缓存的方案优化这部分场景，如果是相同的SQL语句，会优先命中一级缓存，避免直接对数据库进行查询，提高性能

每个SqlSession中持有了`Executor`，每个Executor中有一个`LocalCache`。当用户发起查询时，MyBatis根据当前执行的语句生成`MappedStatement`，在Local Cache进行查询，如果缓存命中的话，直接返回结果给用户，如果缓存没有命中的话，查询数据库，结果写入`Local Cache`，最后返回结果给用户

**配置**

开发者只需在MyBatis的配置文件中，添加如下语句，就可以使用一级缓存。共有两个选项，SESSION或者STATEMENT，默认是SESSION级别，即在一个MyBatis会话中执行的所有语句，都会共享这一个缓存。

一种是`STATEMENT`级别，可以理解为缓存只对当前执行的这一个`Statement`有效。

```xml
<setting name="localCacheScope" value="SESSION"/>
```

# 二级缓存

如果多个SqlSession之间需要共享缓存，则需要使用到二级缓存。开启二级缓存后，会使用`CachingExecutor`装饰Executor，进入一级缓存的查询流程前，先在`CachingExecutor`进行二级缓存的查询

在MyBatis的配置文件中开启二级缓存

```xml
<setting name="cacheEnabled" value="true"/>
```

在MyBatis的映射XML中配置cache或者 `cache-ref`

cache标签用于声明这个namespace使用二级缓存，并且可以自定义配置

```xml
<cache/>   
```

- type：cache使用的类型，默认是PerpetualCache，这在一级缓存中提到过。
- eviction： 定义回收的策略，常见的有FIFO，LRU。
- flushInterval： 配置一定时间自动刷新缓存，单位是毫秒。
- size： 最多缓存对象的个数。
- readOnly： 是否只读，若配置可读写，则需要对应的实体类能够序列化。
- blocking： 若缓存中找不到对应的key，是否会一直blocking，直到有对应的数据进入缓存。
- cache-ref代表引用别的命名空间的Cache配置，两个命名空间的操作使用的是同一个Cache。

```xml
<cache-ref namespace="mapper.StudentMapper"/>
```

**脏数据**

MyBatis的二级缓存的粒度是Mapper，即一个Mapper对应一个cache缓存，那么如果我们在做查询的操作了关联表，比如查询用户和关联的公司信息：

```sql
SELECT id, user_name, company_info form tbl_user, tbl_company where tbl_user.company_id=company.id
```

假如我们在user的Mapper中缓存了对应的查询数据，但是如果我们在company对应的Mapper中修改了`company_info`信息，那么在user的缓存中是不会被更新到的，所以这个时候就可能会出现脏数据了。所以在使用的使用要考虑避免这种情况