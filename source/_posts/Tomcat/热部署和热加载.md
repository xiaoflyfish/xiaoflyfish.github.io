---
title: 热部署和热加载
categories: 
- Tomcat
---

热部署和热加载是类似的，都是在不重启Tomcat的情况下，使得应用的最新代码生效。
热部署表示重新部署应用，它的执行主体是Host，表示主机。
热加载表示重新加载class，它的执行主体是Context，表示应用。

# 后台线程

热部署和热加载都需要监听相应的文件或文件夹是否发生了变化。它们都是由Tomcat的后台线程触发的。

**BackgroundProcessor**就表示后台线程。

每个容器都可以拥有一个BackgroundProcessor，但是默认情况下只有Engine容器会在启动的时候启动一个BackgroundProcessor线程。

该线程会每隔一段时间（可以设置，单位为秒），去执行后台任务，先执行本容器定义的后台任务，然后再执行子容器的定义的后台任务，子容器的任务执行完成后会继续执行其子容器的任务，直到没有子容器为止。**从这里可以看出就算每个容器自己开启一个BackgroundProcessor，也只不过是多了一个执行相同任务的线程而已，执行任务的效率有所提升。**

# 热加载

我们可以在Context上配置reloadable属性为true，这样就表示该应用开启了热加载功能，默认是false。

热加载触发的条件是：**WEB-INF/classes目录下的文件发生了变化，WEB-INF/lib目录下的jar包添加、删除、修改都会触发热加载。**

> 注意：虽然我们在热加载的过程发现它是先停止再启动，做法看似粗暴，但是这样是性价比比较高的，并且这种方式至少比重启Tomcat效率要高很多。

> 注意：热加载不能用于war包

# 热部署

对于一个文件夹部署的应用，通常会检查以下资源是否发生变动：

```
/tomcat-7/webapps/应用名.war
/tomcat-7/webapps/应用名
/tomcat-7/webapps/应用名/META-INF/context.xml
/tomcat-7/conf/Catalina/localhost/应用名.xml
/tomcat-7/conf/context.xml
```

对于一个War部署的应用，会检查以下资源是否发生变动：

```
/tomcat-7/webapps/应用名.war
/tomcat-7/conf/Catalina/localhost/应用名.xml
/tomcat-7/conf/context.xml
```

一旦这些文件或目录发生了变化，就会触发热部署，当然热部署也是有开关的，在Host上，默认是开启的

这里需要注意的是，对于一个目录是否发生了变化，Tomcat只判断了这个目录的修改时间是否发生了变化，所以和热加载是不冲突的，因为热加载监听的是`WEB-INF/classes`和`WEB-INF/lib`目录，而热部署监听的是应用名那一层的目录

应用部署的优先级，对于一个应用，我们可以在四个地方进行定义：

```
server.xml中的context节点
/tomcat-7/conf/Catalina/localhost/应用名.xml
/tomcat-7/webapps/应用名.war
/tomcat-7/webapps/应用名
```

优先级就是上面所列的顺序，意思是同一个应用名，如果你在这个四个地方都配置了，那么优先级低的将不起作用。因为Tomcat在部署一个应用的时候，会先查一下这个应用名是否已经被部署过了。

**热部署的过程：**

如果发生改变的是文件夹，比如`/tomcat-7/webapps/应用名`，那么不会做什么事情，只是会更新一下记录的修改时间，这是因为这个`/tomcat-7/webapps/应用名目录下的文件`，要么是jsp文件，要么是其他文件，而Tomcat只会管jsp文件，而对于jsp文件如果发生了修改，jsp自带的机制会处理修改的。

如果发生改变的是`/tomcat-7/conf/Catalina/localhost/应用名.xml文件`，那么就是先undeploy，然后再deploy，和热加载其实类似。对于undeploy就不多说了，就是讲当前应用从host从移除，这就包括了当前应用的停止和销毁，然后还会从已部署列表中移除当前应用，然后调用deployApps()就可以重新部署应用了。