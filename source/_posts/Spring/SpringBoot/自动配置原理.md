---
title: 自动配置原理
categories: 
- Spring
- SpringBoot
---

**@SpringBootApplication注解**

> SpringBoot 项目的一切都要从 `@SpringBootApplication` 这个注解开始说起

@SpringBootApplication 标注在某个类上说明：

- 这个类是 SpringBoot 的主配置类。
- SpringBoot 就应该运行这个类的 main 方法来启动 SpringBoot 应用。

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootConfiguration
@EnableAutoConfiguration
@ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })
public @interface SpringBootApplication {
```

可以看到 `SpringBootApplication` 注解是一个组合注解，其主要组合了一下三个注解：

- `@SpringBootConfiguration`：该注解表示这是一个 SpringBoot 的配置类，其实它就是一个 @Configuration 注解而已。
- `@ComponentScan`：开启组件扫描。
- `@EnableAutoConfiguration`：从名字就可以看出来，就是这个类开启自动配置的。嗯，自动配置的奥秘全都在这个注解里面。

**@EnableAutoConfiguration注解**

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage
@Import(AutoConfigurationImportSelector.class)
public @interface EnableAutoConfiguration {
```

**@AutoConfigurationPackage**

> 从字面意思理解就是自动配置包。点进去可以看到就是一个 @Import 注解：`@Import({Registrar.class})`，导入了一个 Registrar 的组件

我们在 Registrar 类中的 registerBeanDefinitions 方法上打上断点，可以看到返回了一个包名，该包名其实就是主配置类所在的包。

@AutoConfigurationPackage 注解就是将主配置类（@SpringBootConfiguration标注的类）的**所在包及下面所有子包**里面的所有组件扫描到Spring容器中。所以说，默认情况下主配置类包及子包以外的组件，Spring 容器是扫描不到的。

**@Import({AutoConfigurationImportSelector.class})**

> 该注解给当前配置类导入另外的 N 个自动配置类

**配置类导入规则**

我们知道 AutoConfigurationImportSelector 的 selectImports 就是用来返回需要导入的组件的全类名数组的，那么如何得到这些数组

在 selectImports 方法中调用了一个 getAutoConfigurationEntry() 方法

调用链：在 getAutoConfigurationEntry() -> getCandidateConfigurations() -> loadFactoryNames()

在这里 loadFactoryNames() 方法传入了 `EnableAutoConfiguration.class` 这个参数。先记住这个参数，等下会用到。

loadFactoryNames() 中关键的三步：

1. 从当前项目的类路径中获取所有 `META-INF/spring.factories` 这个文件下的信息。
2. 将上面获取到的信息封装成一个 Map 返回。
3. 从返回的 Map 中通过刚才传入的 `EnableAutoConfiguration.class` 参数，获取该 key 下的所有值。

**META-INF/spring.factories探究**

当然在很多第三方依赖中都会有这个文件，一般每导入一个第三方的依赖，除了本身的jar包以外，还会有一个 `xxx-spring-boot-autoConfigure`，这个就是第三方依赖自己编写的自动配置类

可以看到 EnableAutoConfiguration 下面有很多类，这些就是我们项目进行自动配置的类。

一句话：将类路径下 `META-INF/spring.factories` 里面配置的所有 EnableAutoConfiguration 的值加入到 Spring 容器中。



